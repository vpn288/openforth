Обработка сообщений Windows

Обработка сообщений производится в inWinProc. 
inWinProc - векторное слово, которому подключается необходимая процедура обработки сообщений.

ASSEMBLER FORTH32 LINK   ASSEMBLER CONTEXT !

HEADER winproc HERE CELL+ ,
  push_rcx push_rdx push_r8 push_r9 push_rbx push_rsi push_rdi 
  mov_rax,# hwnd ,   mov_[rax],rcx   
  mov_rax,# wmsg ,   mov_[rax],rdx   
  mov_rax,# wparam , mov_[rax],r8	 
  mov_rax,# lparam , mov_[rax],r9	 
 
  mov_rax,# ' inWinProc  , 
  mov_r11,# ' Push @ ,    call_r11 
  mov_r11,# ' EXECUTE @ , call_r11 
  mov_r11,# ' Pop @ ,     call_r11 
  
  test_rax,rax
  jne	forward> 
  pop_rdi pop_rsi pop_rbx pop_r9 pop_r8 pop_rdx pop_rcx
  ret 
 
  >forward  
  pop_rdi pop_rsi pop_rbx pop_r9 pop_r8 pop_rdx pop_rcx 
  push_rcx     push_rdx push_r8 push_r9 push_rbx push_rsi push_rdi 
	 
  mov_r11,# ' DefWindowProcA CELL+ @ ,
  sub_rsp,b# 0x 20 B,
  call_r11 
  add_rsp,b# 0x 20 B, 
  pop_rdi pop_rsi pop_rbx pop_r9 pop_r8 pop_rdx pop_rcx
  ret
 ALIGN

FORTH32 CONTEXT !

1 вариант
Имена сообщений определяются как константы. В inWinProc используется Case.
WORD: userinWinProc    
			
     Case 
				
    wmsg @  WM_LBUTTONDOWN =  Of   do_something    0 EndOf 
	
    wmsg @  WM_LBUTTONUP   =  Of   do_something_1  0 EndOf
	
    wmsg @  WM_MOUSEMOVE   =  Of   do_something_2  0 EndOf

    wmsg @  WM_PAINT       =  Of   do_something_3  0 Endof

   1 EndCase 	
    
 ;WORD 
 
 2 вариант
 Спрятать конструкцию Case ... EndCase и одинаковые слова.
 
 Писать
 WM_LBUTTONDOWN{ do_something   }WM_LBUTTONDOW
 WM_LBUTTONUP{   do_something_1 }WM_LBUTTONUP
 что и короче и нагляднее.
 
 Для этого надо "разорвать" Of ... EndOf по разным определениям. В силу того, что эти квазиметки-теги используются
 внутри определения, это сделать просто. Оба слова-тега должны быть немедленного исполнения и компилировать 
 конструкцию управления.

 WORD: (wm_lbuttondown) wmsg @  WM_LBUTTONDOWN = ;WORD 
 
 IMMEDIATES CURRENT ! 
 
 WORD:   WM_LBUTTONDOWN{       COMPILE (wm_lbuttondown) COMPILE ?OF HERE    COMPILE 0 ;WORD 

 WORD:   }WM_LBUTTONDOWN       THEN  COMPILE 0 ;WORD 
 
 FORTH32 CURRENT ! 

То-есть аналогично словам Of Then слова WM_LBUTTONDOWN{  }WM_LBUTTONDOWN скомпилируют конструкцию управления и необходимые
к ней добавки. Сразу видны недостатки такого написания. Придется писать по паре определений для каждого сообщения Windows.
Закрывающий тэг, как видно, одинаков для всех сообщений. Назовем его универсально }} двойную скобку сложнее забыть и потерять
в тексте.





